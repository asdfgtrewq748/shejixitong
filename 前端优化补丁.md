# 前端优化补丁说明

## 需要在 MiningDesignSystem.jsx 中添加的功能

### 1. 添加煤柱绘制（在绘制工作面之后）

在 `animate()` 函数中，工作面绘制代码之后添加：

```javascript
// 绘制煤柱（在工作面之后）
if (designData.pillars && designData.pillars.length > 0) {
  designData.pillars.forEach((pillar, idx) => {
    const { x, y, width: w, length: h } = pillar
    
    // 煤柱背景 - 使用深色表示煤柱
    ctx.fillStyle = 'rgba(100, 116, 139, 0.5)' // 灰色半透明
    ctx.fillRect(x, y, w, h)
    
    // 煤柱边框 - 虚线边框
    ctx.strokeStyle = '#64748b'
    ctx.lineWidth = 1
    ctx.setLineDash([5, 5])
    ctx.strokeRect(x, y, w, h)
    ctx.setLineDash([])
    
    // 煤柱斜线填充图案（表示保护区）
    ctx.strokeStyle = 'rgba(100, 116, 139, 0.3)'
    ctx.lineWidth = 1
    const spacing = 10
    for (let offset = -h; offset < w; offset += spacing) {
      ctx.beginPath()
      const startX = x + offset
      const startY = y
      const endX = x + offset + h
      const endY = y + h
      ctx.moveTo(Math.max(x, startX), startX < x ? startY + (x - startX) : startY)
      ctx.lineTo(Math.min(x + w, endX), endX > x + w ? endY - (endX - x - w) : endY)
      ctx.stroke()
    }
    
    // 煤柱标签（仅在缩放足够大时显示）
    if (scale > 0.6) {
      ctx.fillStyle = '#94a3b8'
      ctx.font = `${Math.max(8, 9 / scale)}px "Courier New"`
      ctx.textAlign = 'center'
      ctx.fillText(pillar.id || `PL-${String(idx + 1).padStart(2, '0')}`, x + w / 2, y + h / 2)
    }
  })
}
```

### 2. 添加设计参数面板状态

在组件顶部的状态定义中添加：

```javascript
const [designParams, setDesignParams] = useState({
  userFaceWidth: null,    // 用户自定义工作面宽度
  userPillarWidth: null,  // 用户自定义煤柱宽度
  boundaryPillar: 30,     // 边界煤柱
  minScore: 50            // 最低评分
});
const [showParamsPanel, setShowParamsPanel] = useState(false);
```

### 3. 修改 handleGenerateDesign 函数

将设计参数传递给后端：

```javascript
const handleGenerateDesign = async () => {
  setIsLoading(true);
  addLog('启动深度学习推理引擎 (ResNet-Geology)...', 'warning');
  try {
    // ... 前面的代码保持不变 ...
    
    const designRequestParams = {
      mode: displayDimension,
      userFaceWidth: designParams.userFaceWidth,
      userPillarWidth: designParams.userPillarWidth,
      boundaryPillar: designParams.boundaryPillar,
      minScore: designParams.minScore,
      userEdits: userEdits.roadways.length > 0 || userEdits.workfaces.length > 0 
        ? userEdits 
        : undefined
    };
    
    const design = await api.generateDesign(designRequestParams);
    setDesignData(design);
    
    // 输出设计参数信息
    if (design.designParams) {
      const dp = design.designParams;
      addLog(`  - 工作面宽度: ${dp.workfaceWidth}m`, 'info');
      addLog(`  - 煤柱宽度: ${dp.pillarWidth}m`, 'info');
      addLog(`  - 布局方向: ${dp.layoutDirection}`, 'info');
      addLog(`  - 开采方式: ${dp.miningMethod}`, 'info');
      if (design.stats) {
        addLog(`  - 总开采面积: ${design.stats.totalArea}m²`, 'info');
      }
    }
    
    // ... 后面的代码保持不变 ...
  }
  // ... catch 和 finally 保持不变 ...
};
```

### 4. 添加参数调整面板组件（在主界面中添加）

在 synthesis 标签页中添加参数调整区域：

```jsx
{/* 设计参数调整面板 */}
{activeTab === 'synthesis' && (
  <div className="glass-panel p-4 mb-4">
    <div className="flex items-center justify-between mb-3">
      <h3 className="text-sm font-semibold text-cyan-400 flex items-center gap-2">
        <Settings className="w-4 h-4" />
        设计参数调整
      </h3>
      <button
        onClick={() => setShowParamsPanel(!showParamsPanel)}
        className="text-xs text-gray-400 hover:text-white"
      >
        {showParamsPanel ? '收起' : '展开'}
      </button>
    </div>
    
    {showParamsPanel && (
      <div className="space-y-3">
        <div>
          <label className="text-xs text-gray-400 block mb-1">
            工作面宽度 (m)
          </label>
          <input
            type="number"
            value={designParams.userFaceWidth || ''}
            onChange={(e) => setDesignParams(prev => ({
              ...prev,
              userFaceWidth: e.target.value ? parseInt(e.target.value) : null
            }))}
            placeholder="自动计算"
            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white"
            min="100"
            max="300"
          />
          <p className="text-xs text-gray-500 mt-1">留空则根据地质条件自动计算（100-300m）</p>
        </div>
        
        <div>
          <label className="text-xs text-gray-400 block mb-1">
            煤柱宽度 (m)
          </label>
          <input
            type="number"
            value={designParams.userPillarWidth || ''}
            onChange={(e) => setDesignParams(prev => ({
              ...prev,
              userPillarWidth: e.target.value ? parseInt(e.target.value) : null
            }))}
            placeholder="自动计算"
            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white"
            min="20"
            max="40"
          />
          <p className="text-xs text-gray-500 mt-1">留空则按规程计算（20-40m）</p>
        </div>
        
        <div>
          <label className="text-xs text-gray-400 block mb-1">
            边界保护煤柱 (m)
          </label>
          <input
            type="number"
            value={designParams.boundaryPillar}
            onChange={(e) => setDesignParams(prev => ({
              ...prev,
              boundaryPillar: parseInt(e.target.value) || 30
            }))}
            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white"
            min="20"
            max="50"
          />
        </div>
        
        <div>
          <label className="text-xs text-gray-400 block mb-1">
            最低评分要求
          </label>
          <input
            type="number"
            value={designParams.minScore}
            onChange={(e) => setDesignParams(prev => ({
              ...prev,
              minScore: parseInt(e.target.value) || 50
            }))}
            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm text-white"
            min="0"
            max="100"
          />
        </div>
        
        <button
          onClick={handleGenerateDesign}
          disabled={isLoading}
          className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white px-3 py-2 rounded text-sm font-semibold transition-all disabled:opacity-50"
        >
          重新生成设计
        </button>
      </div>
    )}
  </div>
)}
```

### 5. 添加图层控制（显示/隐藏煤柱）

在现有的图层控制中添加：

```javascript
const [showPillars, setShowPillars] = useState(true);
```

在煤柱绘制代码外层添加条件：

```javascript
// 绘制煤柱（添加开关控制）
if (showPillars && designData.pillars && designData.pillars.length > 0) {
  // ... 煤柱绘制代码 ...
}
```

在UI中添加切换按钮：

```jsx
<button
  onClick={() => setShowPillars(!showPillars)}
  className={`px-3 py-1.5 rounded text-xs transition-colors ${
    showPillars 
      ? 'bg-slate-700 text-white' 
      : 'bg-slate-800 text-gray-400'
  }`}
>
  煤柱
</button>
```

## 关键修改总结

1. **煤柱可视化**：添加灰色半透明矩形 + 斜线图案，与工作面区分
2. **参数调整面板**：允许用户自定义工作面和煤柱宽度
3. **实时参数传递**：将用户输入的参数传递给后端API
4. **图层控制**：可独立控制煤柱的显示/隐藏
5. **参数信息展示**：在日志中显示计算出的设计参数

## 测试要点

- 测试参数留空时是否使用自动计算
- 测试自定义参数是否正确传递到后端
- 测试煤柱绘制是否正确显示在工作面之间
- 测试图层开关是否正常工作
